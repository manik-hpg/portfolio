---
import { Sun, Moon, Menu, X } from 'lucide-astro';

const navLinks = [
  { href: '/projects', label: 'Projects' },
  { href: '/blog', label: 'Blog' },
];

const pathname = Astro.url.pathname;
---

<header id="nav" class="fixed top-0 left-0 right-0 z-50 transition-all duration-200">
  <nav class="container-wide h-16 flex items-center justify-between" aria-label="Main navigation">
    <!-- Logo -->
    <a href="/" class="hover:opacity-70 transition-opacity" aria-label="Home">
      <svg width="32" height="32" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" class="block">
        <rect width="32" height="32" rx="6" class="fill-gray-900 dark:fill-neutral-50"/>
        <text x="16" y="21" font-family="system-ui, sans-serif" font-size="13" font-weight="600" class="fill-white dark:fill-neutral-900" text-anchor="middle">MS</text>
      </svg>
    </a>

    <!-- Desktop Navigation -->
    <div class="hidden md:flex items-center gap-8">
      {navLinks.map(link => (
        <a
          href={link.href}
          class:list={[
            'text-sm font-medium transition-colors',
            pathname === link.href || pathname.startsWith(link.href + '/')
              ? 'text-gray-900 dark:text-neutral-50'
              : 'text-gray-500 dark:text-neutral-400 hover:text-gray-900 dark:hover:text-neutral-50'
          ]}
        >
          {link.label}
        </a>
      ))}

      <!-- Theme Toggle -->
      <button
        id="theme-toggle"
        type="button"
        aria-label="Toggle dark mode"
        class="p-2 rounded-lg text-gray-500 dark:text-neutral-400 hover:bg-gray-100 dark:hover:bg-neutral-800 transition-colors"
      >
        <Sun class="w-5 h-5 hidden dark:block" />
        <Moon class="w-5 h-5 block dark:hidden" />
      </button>
    </div>

    <!-- Mobile Menu Button -->
    <div class="flex md:hidden items-center gap-2">
      <button
        id="theme-toggle-mobile"
        type="button"
        aria-label="Toggle dark mode"
        class="p-2 rounded-lg text-gray-500 dark:text-neutral-400 hover:bg-gray-100 dark:hover:bg-neutral-800 transition-colors"
      >
        <Sun class="w-5 h-5 hidden dark:block" />
        <Moon class="w-5 h-5 block dark:hidden" />
      </button>

      <button
        id="mobile-menu-toggle"
        type="button"
        aria-label="Open menu"
        aria-expanded="false"
        aria-controls="mobile-menu"
        class="p-2 rounded-lg text-gray-500 dark:text-neutral-400 hover:bg-gray-100 dark:hover:bg-neutral-800 transition-colors"
      >
        <Menu class="w-5 h-5" id="menu-icon" />
        <X class="w-5 h-5 hidden" id="close-icon" />
      </button>
    </div>
  </nav>

  <!-- Mobile Menu -->
  <div
    id="mobile-menu"
    class="hidden md:hidden border-t border-gray-200 dark:border-neutral-800 bg-white dark:bg-neutral-950"
  >
    <div class="container-wide py-4 flex flex-col">
      {navLinks.map(link => (
        <a
          href={link.href}
          class:list={[
            'py-3 text-base font-medium border-b border-gray-100 dark:border-neutral-800 last:border-0 transition-colors',
            pathname === link.href || pathname.startsWith(link.href + '/')
              ? 'text-gray-900 dark:text-neutral-50'
              : 'text-gray-500 dark:text-neutral-400'
          ]}
        >
          {link.label}
        </a>
      ))}
    </div>
  </div>
</header>

<!-- Spacer for fixed nav -->
<div class="h-16"></div>

<script>
  // Theme toggle functionality
  function setupThemeToggle() {
    const toggles = document.querySelectorAll('#theme-toggle, #theme-toggle-mobile');

    toggles.forEach(toggle => {
      toggle.addEventListener('click', () => {
        const isDark = document.documentElement.classList.toggle('dark');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
      });
    });
  }

  // Mobile menu functionality
  function setupMobileMenu() {
    const menuToggle = document.getElementById('mobile-menu-toggle');
    const mobileMenu = document.getElementById('mobile-menu');
    const menuIcon = document.getElementById('menu-icon');
    const closeIcon = document.getElementById('close-icon');

    if (!menuToggle || !mobileMenu || !menuIcon || !closeIcon) return;

    menuToggle.addEventListener('click', () => {
      const isExpanded = menuToggle.getAttribute('aria-expanded') === 'true';

      menuToggle.setAttribute('aria-expanded', (!isExpanded).toString());
      mobileMenu.classList.toggle('hidden');
      menuIcon.classList.toggle('hidden');
      closeIcon.classList.toggle('hidden');
    });
  }

  // Nav scroll effect
  function setupNavScroll() {
    const nav = document.getElementById('nav');
    if (!nav) return;

    const handleScroll = () => {
      if (window.scrollY > 10) {
        nav.classList.add(
          'bg-white/80',
          'dark:bg-neutral-950/80',
          'backdrop-blur-sm',
          'border-b',
          'border-gray-200',
          'dark:border-neutral-800'
        );
      } else {
        nav.classList.remove(
          'bg-white/80',
          'dark:bg-neutral-950/80',
          'backdrop-blur-sm',
          'border-b',
          'border-gray-200',
          'dark:border-neutral-800'
        );
      }
    };

    window.addEventListener('scroll', handleScroll, { passive: true });
    handleScroll(); // Check initial state
  }

  // Initialize
  setupThemeToggle();
  setupMobileMenu();
  setupNavScroll();

  // Re-run on page transitions (Astro View Transitions)
  document.addEventListener('astro:page-load', () => {
    setupThemeToggle();
    setupMobileMenu();
    setupNavScroll();
  });
</script>
